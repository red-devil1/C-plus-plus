//             Experiment No.10:  Connecting PHP with MySQL and Performing CRUD Operations with a Simple 
Login System

// a. Learn how to connect PHP with MySQL to manage databases. 
b. Learn to perform CRUD operations – Create, Read, Update, Delete – using PHP and MySQL. 
c. Learn to build a simple login system using sessions and cookies for user authentication. 

1 Database Setup (MySQL)

CREATE DATABASE mydb;
USE mydb;
CREATE TABLE users (
    id INT AUTO_INCREMENT PRIMARY KEY,
    username VARCHAR(50) NOT NULL,
    email VARCHAR(50) NOT NULL,
    password VARCHAR(255) NOT NULL
);

2. db.php (Database Connection)
<?php
$servername = "localhost";
$username = "root"; // your MySQL username
$password = "";    // your MySQL password
$dbname = "mydb";

// Create connection
$conn = new mysqli($servername, $username, $password, $dbname);

// Check connection
if ($conn->connect_error) {
    die("Connection failed: " . $conn->connect_error);
}
?>

3. register.php (Create a new user)
<?php
include 'db.php';

if(isset($_POST['submit'])) {
    $username = $_POST['username'];
    $email = $_POST['email'];
    $password = password_hash($_POST['password'], PASSWORD_DEFAULT);
    // secure password
if(isset($_POST['submit'])) {
    $Username = $_POST['username'];
    $Email = $_POST['email'];
    $Password = $_POST['password'];
    // secure password
    $Password = password_hash($_POST['password'], PASSWORD_DEFAULT);
    
    $sql = "INSERT INTO users (username, email, password) VALUES 
    ('$Username', '$Email', '$Password')";
    
    if($conn->query($sql)) {
        echo "Registration successful!";
    } else {
        echo "Error: " . $conn->error;
    }
}
?>

<form method="POST">
    Username: <input type="text" name="username" required><br>
    Email: <input type="email" name="email" required><br>
    Password: <input type="password" name="password" required><br>
    <input type="submit" name="submit" value="Register">
</form>

<?php 

// 4. login.php (User Login)

session_start();
include 'db.php';

if(isset($_POST['login'])) {
    $Username = $_POST['username'];
    $Password = $_POST['password'];

    $sql = "SELECT * FROM users WHERE username='$Username'";
    $result = $conn->query($sql);
    
    if($result->num_rows > 0) {
        $user = $result->fetch_assoc();
        if(password_verify($Password, $user['password'])) {
            $_SESSION['username'] = $Username; // start session
            setcookie("username", $Username, time()+3600); // cookie valid 1 hour
            echo "Login successful!";
        } else {
    echo "Invalid password!";
}

} else {
    echo "User not found!";
}

?>

<form method="POST">
Username: <input type="text" name="username" required><br>
Password: <input type="password" name="password" required><br>
<input type="submit" name="login" value="Login">
</form>

5. users.php (Read / Display users)
<?php
include 'db.php';

$sql = "SELECT * FROM users";
$result = $conn->query($sql);

if($result->num_rows > 0){
    while($row = $result->fetch_assoc()){
        echo "ID: " . $row['id'] . " | Name: " . $row['username'] . " | Email: " . $row['email'] . ". <br>";
    }
} else {
    echo "No users found.";
}

?>

6. update.php (Update user)
<?php
include 'db.php';

if(isset($_POST['update'])){
$id = $_POST['id'];
$email = $_POST['email'];

$sql = "UPDATE users SET email='$email' WHERE id='$id'";

if($conn->query($sql)){
    echo "User updated successfully!";
} else {
    echo "Error: " . $conn->error;
}
?>

<form method="POST">
    User ID: <input type="number" name="id" required><br>
    New Email: <input type="email" name="email" required><br>
    <input type="submit" name="update" value="Update">
</form>

7. delete.php (Delete user)

<?php
include 'db.php';
if(isset($_POST['delete'])){
    $id = $_POST['id'];

    $sql = "DELETE FROM users WHERE id='$id'";

    if($conn->query($sql)){
        echo "User deleted successfully!";
    } else {
        echo "Error: " . $conn->error;
    }
}
?>

<form method="POST">
    User ID: <input type="number" name="id" required><br>
    <input type="submit" name="delete" value="Delete">
</form>
